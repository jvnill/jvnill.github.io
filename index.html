<!DOCTYPE html>
<html>
  <head>
    <title>Ckt01</title>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js' type='text/javascript'></script>
  </head>

  <body style='margin:0; padding:0; overflow:hidden;'>
    <h1>Initializing...</h1>
    <iframe src='https://meet.jit.si/ckt01' frameborder='0' width='100%' style='position:fixed; height:calc(100% - 50px)'></iframe>

    <div id='login' style='display:none; position:fixed; bottom:0; left:0;'>
      <form action='/' id='form'>
        <label>
          Name
          <br>
          <input type='text' name='name' id='name'>
        </label>

        <div><button type='submit'>Play</button></div>
      </form>
    </div>

    <div id='controls' style='display:none; position:fixed; bottom:0; left:0;'>
      <div><a href='' id='reset'>Reset</a></div>
      <div><a href='' id='buzz'>Buzz</a></div>

      <ul id='buzzed'></ul>
    </div>

    <script>
      let client = new Paho.MQTT.Client('broker.hivemq.com', 8000, Math.random().toString(36).substring(7));

      client.connect({
        onSuccess: function() {
          client.subscribe('ckt01', {});
          document.getElementsByTagName('h1')[0].style.display = 'none';
          document.getElementById('login').style.display = 'block';
        }
      });

      client.onConnectionLost = function(responseObject) {
        console.log(`onConnectionLost: ${responseObject.errorMessage}`);
      };

      client.onMessageArrived = function(message) {
        let payload = JSON.parse(message.payloadString);

        if (payload.action == 'reset') {
          document.getElementById('buzzed').innerHTML = '';
          document.getElementById('buzz').style.display = 'block';

        } else if (payload.action == 'buzz') {
          let node = document.createElement('li');
          let textnode = document.createTextNode(payload.name);

          node.appendChild(textnode);
          document.getElementById('buzzed').appendChild(node);
        }
      };

      document.getElementById('form').addEventListener('submit', function(event) {
        event.preventDefault();

        let name = document.getElementById('name').value;

        if (name && name.length) {
          window.userName = name;
          document.getElementById('login').style.display = 'none';
          document.getElementById('controls').style.display = 'block';
        }
      });

      document.getElementById('reset').addEventListener('click', function(event) {
        event.preventDefault();

        let message = new Paho.MQTT.Message(JSON.stringify({ action: 'reset' }));

        message.destinationName = 'ckt01';

        client.send(message);
      });

      document.getElementById('buzz').addEventListener('click', function(event) {
        event.preventDefault();

        let message = new Paho.MQTT.Message(JSON.stringify({ action: 'buzz', name: window.userName }));

        message.destinationName = 'ckt01';

        client.send(message);
        this.style.display = 'none';
      });
    </script>
  </body>
</html>
